<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>CAPUSTA</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
</head>
<body>

  <div class="container">

    <div class="top-bar">
      <div class="nav-group">
        <button class="tab-btn active" data-tab="calculator"><i class="fas fa-calculator mr-1"></i> КАЛЬКУЛЯТОР</button>
        <button class="tab-btn" data-tab="crm"><i class="fas fa-briefcase mr-1"></i> CRM</button>
        <button class="tab-btn" data-tab="price"><i class="fas fa-tags mr-1"></i> ПРАЙС</button>
        <button class="tab-btn" data-tab="settings"><i class="fas fa-cog mr-1"></i> НАСТРОЙКИ</button>
      </div>
      <div class="nav-group">
        <button class="action-btn" id="saveAllBtn" style="display:none;"><i class="fas fa-save mr-1"></i> СОХРАНИТЬ</button>
        <button class="action-btn" id="exportBtn"><i class="fas fa-file-export mr-1"></i> ЭКСПОРТ</button>
      </div>
    </div>

    <div class="content-area">

      <!-- TAB: КАЛЬКУЛЯТОР -->
      <div id="tab-calculator" class="tab-content" style="display:block;">

        <div class="tender-info">
          <div class="section-title" style="margin-bottom: var(--space-lg);">
            <span>Информация о закупке</span>
            <button class="btn-secondary" id="reParseBtn"><i class="fas fa-sync-alt mr-1"></i> Обновить</button>
          </div>

          <div class="info-row">
            <span class="info-label">Ссылка:</span>
            <input type="text" id="tenderUrl" class="info-value" placeholder="https://zakupki.kontur.ru/..." style="border:none;background:transparent;font-family:var(--font-mono);" />
          </div>

          <div class="info-row">
            <span class="info-label">Заказчик:</span>
            <input type="text" id="customerName" class="info-value" placeholder="Название организации" style="border:none;background:transparent;" />
          </div>

          <div class="info-row">
            <span class="info-label">ИНН/КПП:</span>
            <div style="display:flex;gap:var(--space-md);">
              <input type="text" id="customerInn" placeholder="ИНН" style="width:120px;border:none;background:transparent;font-family:var(--font-mono);" />
              <input type="text" id="customerKpp" placeholder="КПП" style="width:120px;border:none;background:transparent;font-family:var(--font-mono);" />
            </div>
          </div>

          <div class="info-row">
            <span class="info-label">Контакт:</span>
            <div style="display:flex;gap:var(--space-md);flex:1;">
              <input type="text" id="contactName" placeholder="ФИО" style="flex:1;border:none;background:transparent;" />
              <input type="tel" id="contactPhone" placeholder="Телефон" style="width:150px;border:none;background:transparent;" />
              <input type="email" id="contactEmail" placeholder="Email" style="width:200px;border:none;background:transparent;" />
            </div>
          </div>

          <div class="info-row">
            <span class="info-label">НМЦ:</span>
            <input type="number" id="nmcValue" class="info-value" placeholder="0" style="border:none;background:transparent;font-family:var(--font-mono);text-align:right;" />
          </div>

          <div class="info-row">
            <span class="info-label">Обеспечение заявки:</span>
            <div style="display:flex;align-items:center;gap:var(--space-sm);">
              <input type="number" id="bidSecurity" placeholder="0" style="width:120px;border:none;background:transparent;font-family:var(--font-mono);" />
              <span id="bidSecurityCalc" style="color:var(--text-muted);font-size:12px;"></span>
            </div>
          </div>

          <div class="info-row">
            <span class="info-label">Обеспечение контракта:</span>
            <div style="display:flex;align-items:center;gap:var(--space-sm);">
              <input type="number" id="contractSecurity" placeholder="0" style="width:120px;border:none;background:transparent;font-family:var(--font-mono);" />
              <span id="contractSecurityCalc" style="color:var(--text-muted);font-size:12px;"></span>
            </div>
          </div>

          <div class="info-row">
            <span class="info-label">Тариф площадки:</span>
            <input type="number" id="platformTariff" value="6000" style="width:120px;border:none;background:transparent;font-family:var(--font-mono);" />
          </div>

          <div class="info-row">
            <span class="info-label">Срок услуг:</span>
            <div style="display:flex;gap:var(--space-sm);align-items:center;">
              <input type="date" id="serviceStart" style="border:none;background:transparent;" />
              <span>-</span>
              <input type="date" id="serviceEnd" style="border:none;background:transparent;" />
              <input type="number" id="serviceMonths" placeholder="12" style="width:70px;border:none;background:transparent;font-family:var(--font-mono);text-align:right;" />
              <span>мес</span>
            </div>
          </div>

          <div class="info-row" style="align-items:flex-start;">
            <span class="info-label">Комментарии:</span>
            <div style="flex:1;display:flex;flex-direction:column;gap:8px;">
              <div id="dealCommentsList" class="collapse-content" style="max-height:180px;overflow:auto;padding:0;border:none;"></div>
              <div style="display:flex;gap:8px;">
                <input type="text" id="dealCommentInput" placeholder="Написать комментарий" style="flex:1;" />
                <button class="btn-secondary" id="addCommentBtn">Добавить</button>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">
            <span>Охрана (строки)</span>
            <button class="btn-icon" id="addCalcRowBtn"><i class="fas fa-plus"></i></button>
          </div>

          <table class="data-grid">
            <thead>
              <tr>
                <th>Позиция</th>
                <th class="text-center">Кол-во</th>
                <th class="text-center">ЧЧ/мес</th>
                <th class="text-center">Ч/смена</th>
                <th class="text-center">Мес</th>
                <th class="text-right">₽/час (клиент)</th>
                <th class="text-right">₽/смена (наша)</th>
                <th class="text-right">Выручка/мес</th>
                <th class="text-right">ФОТ/мес</th>
                <th class="text-right">Итого</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="securityRowsBody"></tbody>
          </table>
        </div>

        <div class="section">
          <div class="section-title">
            <span>Допрасходы (строки)</span>
            <button class="btn-icon" id="addExtraRowBtn"><i class="fas fa-plus"></i></button>
          </div>

          <table class="data-grid">
            <thead>
              <tr>
                <th>Название</th>
                <th class="text-center">Кол-во</th>
                <th class="text-right">Цена</th>
                <th class="text-center">Ед.</th>
                <th class="text-center">НДС</th>
                <th class="text-center">Период</th>
                <th class="text-right">Итого</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="extraRowsBody"></tbody>
          </table>

          <div class="summary-card" style="margin-top: var(--space-lg);">
            <div class="summary-grid">
              <div class="summary-item">
                <div class="summary-label">ЧЧ/мес</div>
                <div class="summary-value" id="totalHoursCalc">0,00</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Постов</div>
                <div class="summary-value" id="totalPeopleCalc">0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Средняя ставка</div>
                <div class="summary-value" id="avgRateCalc">0,00</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Итого/мес (охрана+ежемес допы)</div>
                <div class="summary-value" id="totalAmountCalc">0,00</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Допы ежемес</div>
                <div class="summary-value" id="extraTotalCalc">0,00</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Допы разово</div>
                <div class="summary-value" id="extraOnceCalc">0,00</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">ИТОГО по контракту</div>
                <div class="summary-value highlight" id="grandTotalContract">0,00</div>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">
            <span>Схемы (5 колонок)</span>
            <button class="btn-icon" id="toggleSchemesBtn" title="Показать/скрыть детали"><i class="fas fa-chevron-down"></i></button>
          </div>

          <table class="data-grid schemes-table">
            <thead>
              <tr>
                <th style="width:140px;">Метрика</th>
                <th>БЕЛ УСН</th>
                <th>СЕР УСН</th>
                <th>БЕЛ НДС</th>
                <th>СЕР НДС</th>
                <th>ИП НДС</th>
              </tr>
            </thead>
            <tbody id="schemesMatrixBody"></tbody>
          </table>
        </div>

      </div>

      <!-- TAB: CRM -->
      <div id="tab-crm" class="tab-content" style="display:none;">
        <div style="display:flex;gap:6px;margin-bottom:12px;border-bottom:1px solid var(--border-subtle);padding-bottom:6px;">
          <button class="tab-btn active" data-subtab="deals"><i class="fas fa-handshake mr-1"></i> Сделки</button>
          <button class="tab-btn" data-subtab="tasks"><i class="fas fa-tasks mr-1"></i> Задачи</button>
          <button class="tab-btn" data-subtab="counterparties"><i class="fas fa-building mr-1"></i> Контрагенты</button>
          <button class="tab-btn" data-subtab="managers"><i class="fas fa-users mr-1"></i> Менеджеры</button>
        </div>

        <div id="crm-deals" class="crm-subtab" style="display:block;">
          <div id="dealsContainer"></div>
        </div>

        <div id="crm-tasks" class="crm-subtab">
          <div style="padding: 12px; color: var(--text-muted);">MVP: задачи позже.</div>
          <div id="tasksContainer"></div>
        </div>

        <div id="crm-counterparties" class="crm-subtab">
          <input type="text" id="counterpartiesSearch" placeholder="Поиск по ИНН или названию" style="width:100%;margin-bottom:10px;" />
          <table class="data-grid" id="counterpartiesTable">
            <thead><tr><th>Название</th><th>ИНН</th><th>КПП</th><th>Сделок</th><th>Активность</th></tr></thead>
            <tbody id="counterpartiesBody"></tbody>
          </table>
        </div>

        <div id="crm-managers" class="crm-subtab">
          <div style="padding: 12px; color: var(--text-muted);">MVP: менеджеры позже.</div>
          <table class="data-grid" id="managersTable">
            <thead><tr><th>ФИО</th><th>Должность</th><th>Телефон</th><th>Email</th><th></th></tr></thead>
            <tbody id="managersBody"></tbody>
          </table>
        </div>
      </div>

      <!-- TAB: ПРАЙС -->
      <div id="tab-price" class="tab-content">
        <div class="section">
          <div class="section-title">
            <span><i class="fas fa-shield-alt mr-1"></i> Прайс: охрана</span>
            <button class="btn-icon" id="addPriceRowBtn"><i class="fas fa-plus"></i></button>
          </div>
          <table class="data-grid">
            <thead>
              <tr>
                <th>Название</th>
                <th>Регион</th>
                <th class="text-center">Ор.</th>
                <th class="text-center">Ч/смена</th>
                <th class="text-center">ЧЧ/мес</th>
                <th class="text-right">₽/час</th>
                <th class="text-right">₽/смена</th>
                <th class="text-right">Итого/мес</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="priceTableBody"></tbody>
          </table>
        </div>

        <div class="section">
          <div class="section-title">
            <span><i class="fas fa-money-bill mr-1"></i> Прайс: доп. расходы</span>
            <button class="btn-icon" id="addExtraPriceRowBtn"><i class="fas fa-plus"></i></button>
          </div>
          <table class="data-grid">
            <thead>
              <tr>
                <th>Название</th>
                <th class="text-right">Цена</th>
                <th class="text-center">Ед.</th>
                <th class="text-center">НДС</th>
                <th class="text-center">Период</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="extraPriceTableBody"></tbody>
          </table>
        </div>

        <div style="text-align:right;">
          <button class="btn-primary" id="savePriceBtn"><i class="fas fa-check-circle mr-1"></i> Сохранить прайс</button>
        </div>
      </div>

      <!-- TAB: НАСТРОЙКИ -->
      <div id="tab-settings" class="tab-content">

        <div class="section">
          <div class="section-title"><span><i class="fas fa-sliders-h mr-1"></i> Общие настройки</span></div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
            <div>
              <label style="font-size:9px;color:var(--text-muted);">Мин. НМЦ для парсера</label>
              <input type="number" id="minPriceVal" value="350" />
            </div>
            <div>
              <label style="font-size:9px;color:var(--text-muted);">Тема</label>
              <select id="themeSelect">
                <option value="light">light</option>
                <option value="dark">dark</option>
              </select>
            </div>
            <div>
              <label style="font-size:9px;color:var(--text-muted);">VAT mode default</label>
              <select id="vatModeDefault">
                <option value="outside">outside</option>
                <option value="inside">inside</option>
              </select>
            </div>
            <div>
              <label style="font-size:9px;color:var(--text-muted);">Telegram chat id</label>
              <input type="text" id="tgChatId" placeholder="например: 123456789" />
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title"><span><i class="fas fa-scroll mr-1"></i> calcspec.json (редактирование)</span></div>
          <textarea id="calcspecTextArea" rows="14" style="font-size: 11px; font-family: var(--font-mono);"></textarea>
          <div style="margin-top: 8px; color: var(--text-muted); font-size: 11px;">
            Формат: JSON. При ошибке JSON будут использоваться значения по умолчанию из src/calcspec.json.
          </div>
        </div>

        <div style="text-align:right;">
          <button class="btn-primary" id="saveSettingsBtn"><i class="fas fa-save mr-1"></i> Сохранить настройки</button>
        </div>
      </div>

    </div>

  </div>

  <script src="rules.js"></script>
  <script src="data.js"></script>
  <script src="calculator.js"></script>
  <script src="app.js"></script>

</body>
</html>

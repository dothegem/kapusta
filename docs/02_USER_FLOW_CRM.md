<!--
# FILE: docs/02_USER_FLOW_CRM.md
# VERSION: 1.0.0
# START_MODULE_CONTRACT:
# PURPOSE: Описание пользовательских сценариев (User Flow) в CRM от парсинга тендера до закрытия сделки.
# SCOPE: Бизнес-процессы, путь пользователя.
# INPUT: Пользовательские действия (ввод данных, клики, переходы).
# OUTPUT: Описанные последовательности шагов для реализации UX/UI.
# KEYWORDS_MODULE: [DOMAIN(10): UserFlow; PROCESS(9): CRM_Lifecycle; ACTOR(8): Manager; EVENT(8): Parsing]
# LINKS_TO_MODULE: [docs/00_OVERVIEW.md, docs/03_CRM_MODEL_AND_EDIT_SCENARIOS.md]
# LINKS_TO_SPECIFICATION: [Весь проект]
# END_MODULE_CONTRACT
# START_MODULE_MAP:
# PROCESS 10 [Источники данных и парсинг] => parsing_flow
# PROCESS 10 [Создание Tender и CalculationGroup] => creation_flow
# PROCESS 10 [Работа менеджера с расчетами] => calculation_flow
# PROCESS 9 [Связь с CRM и Bitrix24] => crm_sync_flow
# PROCESS 8 [Коммуникации и уведомления] => notification_flow
# END_MODULE_MAP
# START_USE_CASES:
# - [TenderParsing]: Manager (TenderSite) -> RunExtension -> TenderCreated
# - [CalculationSetup]: Manager (CalculatorUI) -> InputParams -> CalculationGenerated
# - [DealClosing]: SalesManager (CRM) -> SendOffer -> DealWon
# END_USE_CASES
# START_CHANGE_SUMMARY
# LAST_CHANGE: Добавлена семантическая разметка для AI-агентов.
# IMPORTANT_NOTICE: Описывает "как это работает" с точки зрения пользователя.
# END_CHANGE_SUMMARY
-->
# 02_USER_FLOW_CRM

## 0. Источники данных и парсинг

### 0.1. Площадки и парсер

Основные источники тендеров — как минимум bidzaar.com и kontur.zakupki.ru, откуда расширение считывает данные через content‑script `parser.js`. [file:8]  
Парсер берёт из DOM ключевые поля тендера (номер, заказчик, дата, объём услуг, закон 44/223, параметры объекта, сроки, НМЦК и т.п.) и упаковывает их в JSON для KAPUSTA. [file:8]  

### 0.2. Типы законов и режимов

Для каждого тендера фиксируется тип закона (44‑ФЗ или 223‑ФЗ), который влияет на дальнейшую стратегию участия, но бизнес‑флоу в KAPUSTA остаётся единым, без разветвления по закону. [file:8]  
Эта информация отображается в UI и попадает в Tender/Deal как часть контекста, а не вносит структурных отличий в CRM‑модель. [file:8]  

## 1. Создание Tender и CalculationGroup

### 1.1. Заголовок Tender

После парсинга система предлагает создать новый Tender в CRM KAPUSTA, заполняя: source (площадка), internalId, sourceTenderId, lawType и ссылку на оригинал. [file:8]  
Tender становится центральным объектом, к которому привязываются CalculationGroup, Deal и все последующие активности. [file:8]  

### 1.2. Инициализация CalculationGroup

Для каждого Tender создаётся хотя бы один CalculationGroup, в котором будут храниться все варианты расчётов по этому тендеру. [file:8]  
При инициализации CalculationGroup может создаваться базовый набор GuardCalcLine/ExpenseCalcLine (например, по типовым постам и расходам), который менеджер потом уточняет. [file:8]  

## 2. Работа менеджера с расчётами

### 2.1. Ввод исходных данных

Менеджер открывает UI калькулятора и вводит ключевые параметры: месячная выручка/часовая ставка, срок контракта, количество постов, график, расходы, режим НДС (inside/outside) и выбор схем (белая/серая/ИП‑схема, НДС, дополнительные расходы). [file:8][file:2][file:6]  
Эти данные попадают в структуру state (inputs + config) и затем используются модулем расчётов на основе calcspec. [file:2][file:6]  

### 2.2. Генерация вариантов Calculation

По введённым параметрам калькулятор рассчитывает несколько схем (например, BELUSN, SERUSN, BELNDS, SERNDS, IPNDS) с разными комбинациями налогов, зарплаты и cashout. [file:8]  
Каждый такой вариант может быть сохранён как отдельный Calculation в составе CalculationGroup, чтобы сравнивать их между собой и отправлять клиенту разные предложения. [file:8]  

## 3. Связь с CRM и Bitrix24

### 3.1. Создание Deal

На основе CalculationGroup создаётся или обновляется сущность Deal в CRM KAPUSTA, которая отражает коммерческую ситуацию (клиент, сумма, стадия). [file:8]  
Параллельно (или по запросу) Deal синхронизируется с Bitrix24, создавая там соответствующую сделку и связанные Company/Contact. [file:8]  

### 3.2. Задачи и SiteSurvey

При переходе Deal в определённые стадии могут автоматически создаваться Task (например, «позвонить клиенту», «уточнить ТЗ», «назначить выезд»). [file:8]  
Для объектов, где требуется осмотр, создаётся/обновляется SiteSurvey, который прикрепляется к Deal/Tender и хранит технические детали объекта охраны. [file:8]  

## 4. Коммуникации и уведомления

### 4.1. Email и документы

Из UI KAPUSTA можно инициировать отправку коммерческого предложения клиенту по email (письмо + вложенный PDF/таблица). [file:8]  
Факт отправки и связанный документ могут логироваться в CRM/Deal, чтобы видеть историю коммуникаций. [file:8]  

### 4.2. Telegram / Mango

Важные события (новый VIP‑лид, переход сделки в критическую стадию, напоминания) дублируются в Telegram‑чаты и через Mango‑телефонию. [file:8]  
Эти каналы используются только как нотификации и точки входа для лидов, без усложнённых собственных CRM‑флоу. [file:8]  

Подробнее про модель данных и сценарии редактирования см. `03_CRM_MODEL_AND_EDIT_SCENARIOS.md`. [file:8]  
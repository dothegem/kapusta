<!--
# FILE: docs/04_CRM_STATES_AND_STATE_MACHINE.md
# VERSION: 1.0.0
# START_MODULE_CONTRACT:
# PURPOSE: Описание жизненного цикла сделки (Deal), машины состояний и правил перехода.
# SCOPE: Управление состояниями, права доступа, автоматизация переходов.
# INPUT: События смены статуса (действия пользователя, триггеры).
# OUTPUT: Формализованная машина состояний (State Machine) для Deal.
# KEYWORDS_MODULE: [DOMAIN(10): DealLifecycle; PATTERN(9): StateMachine; CONCEPT(8): Permissions; EVENT(8): SideEffects]
# LINKS_TO_MODULE: [docs/02_USER_FLOW_CRM.md, docs/03_CRM_MODEL_AND_EDIT_SCENARIOS.md, docs/11_INTEGRATIONS_BITRIX_TELEGRAM_MANGO.md]
# LINKS_TO_SPECIFICATION: [Весь проект]
# END_MODULE_CONTRACT
# START_MODULE_MAP:
# STATE 10 [Стадия: Новая сделка] => stage_new
# STATE 10 [Стадия: В работе] => stage_inwork
# STATE 10 [Стадия: Отправлено КП] => stage_sent
# STATE 10 [Стадия: Выиграна] => stage_won
# STATE 10 [Стадия: Проиграна] => stage_lost
# RULE 9 [Машина состояний и переходы] => state_machine_transitions
# RULE 8 [Побочные эффекты смены стадий] => transition_side_effects
# END_MODULE_MAP
# START_USE_CASES:
# - [MoveToInWork]: SalesManager (Deal:new) -> StartWork -> Deal:inwork
# - [SendOffer]: SalesManager (Deal:inwork) -> EmailSent -> Deal:sent
# - [CloseDeal]: SalesManager (Deal:sent) -> ClientAccepted -> Deal:won
# END_USE_CASES
# START_CHANGE_SUMMARY
# LAST_CHANGE: Добавлена семантическая разметка для AI-агентов.
# IMPORTANT_NOTICE: Определяет логику переходов, критичную для бизнес-процесса.
# END_CHANGE_SUMMARY
-->
# 04_CRM_STATES_AND_STATE_MACHINE

## 0. Обзор стадий Deal

Стадии сделок в KAPUSTA: `new`, `inwork`, `sent`, `won`, `lost`. [file:8]  
Эти стадии видны в UI и синхронизируются с аналогичными стадиями/воронками в Bitrix24. [file:8]  

## 1. Описание стадий

### 1.1. new

`new` — только что созданная сделка/лид; есть базовая информация о тендере/клиенте, но расчёты могут быть не готовы. [file:8]  
На этой стадии разрешено свободно редактировать Tender, CalculationGroup, Guard/Expense‑строки и создавать первые Calculation. [file:8]  

### 1.2. inwork

`inwork` — менеджер активно работает над предложением: уточняет данные, считает схемы, общается с клиентом. [file:8]  
Разрешены изменения в расчётах и сущностях CRM, но уже требуется более аккуратное версионирование при существенных изменениях условий. [file:8]  

### 1.3. sent

`sent` — коммерческое предложение отправлено клиенту (email, портал, и т.п.) и ожидается ответ. [file:8]  
Здесь расчёт, который ушёл клиенту, должен быть зафиксирован или версионирован, чтобы не нарушать историю. [file:8]  

### 1.4. won

`won` — сделка выиграна, клиент согласился на условия. [file:8]  
На этой стадии изменения в расчётах возможны только для отражения фактического исполнения и пост‑аналитики. [file:8]  

### 1.5. lost

`lost` — сделка проиграна (клиент выбрал другого поставщика или тендер отменён). [file:8]  
Сущности становятся архивными; правки ограничены комментариями и пост‑фактум заметками. [file:8]  

## 2. Машина состояний Deal.stage

### 2.1. Разрешённые переходы

- `new` → `inwork` — когда менеджер начинает активную работу над расчётом/предложением. [file:8]  
- `inwork` → `sent` — когда как минимум один Calculation оформлен в КП и отправлен клиенту. [file:8]  
- `sent` → `won` — когда клиент акцептует предложение и есть подтверждение (договор, протокол и т.п.). [file:8]  
- `sent` → `lost` — когда получен отказ, тендер проигран или закрыт без выбора. [file:8]  
- `inwork` → `lost` — если тендер отменён/утерян ещё до отправки КП. [file:8]  

Опционально допустим возврат назад:  
- `sent` → `inwork` — если клиент запросил правки и официально не отказался. [file:8]  

Переходы `won` → что‑то иное считаются запрещёнными в нормальном режиме (можно использовать отдельные флаги для расторжения, но не менять stage). [file:8]  

### 2.2. Разрешения по ролям

- Перевод `new` → `inwork` и `inwork` → `sent` может делать ответственный Sales Manager или Tender Lead. [file:8]  
- Перевод `sent` → `won`/`lost` возможен только для Sales Manager (и/или руководителя), чтобы избежать ошибок от любых пользователей. [file:8]  
- Возврат `sent` → `inwork` допускается ответственным менеджером по согласованию (например, при необходимости внести серьёзные правки по запросу клиента). [file:8]  

## 3. Side‑effects при смене стадий

### 3.1. Автоматические задачи

- `new` → `inwork`: создаётся Task на первичный контакт с клиентом и/или уточнение ТЗ. [file:8]  
- `inwork` → `sent`: создаётся Task «ожидание ответа» с дедлайном по тендеру и напоминанием. [file:8]  
- `sent` → `won`: создаётся серия задач для HR/операционного блока (подбор персонала, подготовка договора, запуск объекта). [file:8]  
- `sent` → `lost`: создаётся Task для анализа причин проигрыша и занесения в базу знаний. [file:8]  

### 3.2. Интеграции и уведомления

- При ключевых переходах стадий могут отправляться уведомления в Telegram (например, новый VIP‑лид, выигранная сделка). [file:8]  
- Изменения стадий синхронизируются с Bitrix24, чтобы статусы были едиными между KAPUSTA и внешней CRM. [file:8]  

Детали маппинга стадий и сущностей с Bitrix24 см. в `11_INTEGRATIONS_BITRIX_TELEGRAM_MANGO.md`. [file:8]  
# PROJECT_CONTEXT (Canonical)

> Migrated from `.info/project-context.md`.
> This is a **single source of truth** for product + data model + UI behavior.

# kapusta — единый контекст (расширение → будущая экосистема)

Этот документ — единственный источник правды для:
- UI расширения (вкладки, таблицы, поведение).
- Данных/сущностей (что и где хранится).
- Расчётных схем (5 колонок) и правил подсчёта.
- Интеграции: сейчас extension-only (локальное хранение), позже общая web-версия/экосистема.

---

## 0) Ключевая идея продукта

Менеджер собирает ОДИН набор строк (охрана + допрасходы), а система автоматически считает результат по 5 схемам и показывает таблицу из 5 колонок.

---

## 1) UI: верхняя навигация (FontAwesome 5)

Верхняя строка (иконки + подписи):

**Слева:**
- КАЛЬКУЛЯТОР
- CRM
- ПРАЙС
- НАСТРОЙКИ

**Справа:**
- СОХРАНИТЬ (появляется только при наличии несохранённых изменений)
- ЭКСПОРТ (сейчас: текст/буфер; позже: PDF тоже)

**Поведение сохранения:**
- При любом изменении данных на текущей вкладке появляется СОХРАНИТЬ.
- Изменения стараемся сохранять максимально "авто" (draft), но если есть несохранённые — показываем предупреждение при уходе/закрытии.

---

## 2) КАЛЬКУЛЯТОР: структура экрана

### 2.1 Шапка тендера / заказчика (Tender Header)
**Источник:** парсер (kontur/bidzaar) или ручной ввод.

**Редактируемость:**
- ВСЁ редактируемое, кроме: `source`, `sourceTenderId`, `lawType`, `links`.
- Если парсер не сработал — все обязательные поля вводятся вручную.

**Поля шапки (минимум):**
- этап, срок окончания подачи, площадка, ссылка
- закон (44-ФЗ/223-ФЗ), тип закупки
- заказчик (название, ИНН, КПП)
- контакт (ФИО, телефон, email)
- НМЦ
- обеспечение заявки (`securityBid`)
- обеспечение контракта (`securityContract`)
- тариф площадки (`platformFee`)
- средняя цена часа с площадки (`hourlyRateCustomer`)
- общее кол-во чч (`totalHours`)
- срок оказания услуг (`serviceStart`/`serviceEnd` + `months`)
- адреса объектов (массив)

### 2.2 Комментарии
Под шапкой:
- список комментариев по хронологии (снизу — самый свежий).
- поле ввода нового комментария + кнопка "Добавить".

### 2.3 Расчёт охраны (Guard Lines)
- Добавляем строки охраны из прайса (прайс — отдельная вкладка).
- В калькуляторе строки редактируются "локально" (обратно в прайс НЕ пишем).
- Нужен "индикатор остатка" (как при добавлении строк уменьшается/раскидывается: `totalHours` и/или бюджет).

#### Поля строки охраны (в калькуляторе)
**Обязательные:**
- краткое описание (текст) — тянем из прайса, редактируем
- режим работы, часы (число) — тянем из прайса, редактируем
- чч/мес (число) — тянем из прайса, редактируем
- ставка заказчика в час (число) — тянем из прайса, редактируем
- ставка сотрудника в смену (число) — тянем из прайса (поле "Ставка"), редактируем
- месяцев (число) — по умолчанию берём из срока тендера (или 12, если нет), редактируем
- кол-во постов (число) — редактируем
- итого в мес (число, авто)
- итого (число, авто)

**Дополнительно (полезно, но можно MVP):**
- адрес объекта (текст)
- форма одежды (enum/текст)
- описание строки (текст, хранится в CRM в составе расчёта)

**Критичное правило ставок:**
- ставка заказчика = "в час"
- ставка сотрудника (наша) = "в смену"
- сравнение/пересчёт делаем через усреднённый месяц 30.5

### 2.4 Дополнительные расходы (Expense Lines)
- Строки подтягиваются из прайса "Доп. расходы" (прайс — отдельная вкладка).
- В калькуляторе строки редактируются "локально".
- **Авто-строки по БГ:**
  - если есть обеспечение заявки — добавляем строку "БГ обеспечение заявки"
  - если есть обеспечение контракта — добавляем строку "БГ обеспечение контракта"
  - стоимость БГ считается по формулам из Excel (см. раздел 6.4)

#### Поля строки допрасхода (в калькуляторе)
- название (текст) — из прайса или авто (БГ)
- единица измерения (шт/день/мес)
- тип НДС/тип оплаты (ндс / без ндс / нал)
- цена (число)
- кол-во (число)
- периодичность (разово/ежемесячно) ← важно для "кол-во мес"
- итого (авто)

### 2.5 ИТОГО и 5 схем
**ИТОГО** = (охрана + допрасходы).

Если **ИТОГО > НМЦ** — подсветка ИТОГО красным, иначе зелёным.

Ниже: **5 колонок схем** (в порядке):
1. БЕЛ УСН
2. СЕР УСН
3. БЕЛ НДС
4. СЕР НДС
5. ИП НДС

В каждой колонке показываем:
- Рентабельность (margin %)
- Прибыль безнал (profitCashless)
- Прибыль нал (profitCash)

**"v"** — кнопка раскрыть выкладки (breakdown) по строкам.

**Цвет рентабельности:**
- < 5% → красный
- < 10% → жёлтый
- >= 10% → зелёный

---

## 3) CRM (внутри расширения)

**Подвкладки:**
- СДЕЛКИ
- ЗАДАЧИ
- КОНТРАГЕНТЫ
- МЕНЕДЖЕРЫ
- (опционально) НАСТРОЙКИ CRM — если нужно отделить от общих настроек расширения

(Дальше — исходный текст без изменения.)

---

## 4) ПРАЙС

(Содержимое перенесено один-в-один из `.info/project-context.md`.)

---

## 5) НАСТРОЙКИ (общие)

---

## 6) ДАННЫЕ (каноническая модель + расширения)

---

## 6.4 Формулы БГ (Excel → код)
**Обеспечение заявки:**
```
cost = MAX(1000; ROUND(securityBid * 0.0055; 0))
```

**Обеспечение контракта:**
```
cost = ROUND(securityContract * 0.0003; 0)
```

---

## 11) Логика расчёта (calc_logic reference)
Полная спецификация логики калькулятора находится в отдельном документе `docs/CALC_LOGIC.md`.

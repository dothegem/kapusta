# kapusta — единый контекст (расширение → будущая экосистема)

Этот документ — единственный источник правды для:
- UI расширения (вкладки, таблицы, поведение).
- Данных/сущностей (что и где хранится).
- Расчётных схем (5 колонок) и правил подсчёта.
- Интеграции: сейчас extension-only (локальное хранение), позже общая web-версия/экосистема.

---

## 0) Ключевая идея продукта

Менеджер собирает ОДИН набор строк (охрана + допрасходы), а система автоматически считает результат по 5 схемам и показывает таблицу из 5 колонок.

---

## 1) UI: верхняя навигация (FontAwesome 5)

Верхняя строка (иконки + подписи):

**Слева:**
- КАЛЬКУЛЯТОР
- CRM
- ПРАЙС
- НАСТРОЙКИ

**Справа:**
- СОХРАНИТЬ (появляется только при наличии несохранённых изменений)
- ЭКСПОРТ (сейчас: текст/буфер; позже: PDF тоже)

**Поведение сохранения:**
- При любом изменении данных на текущей вкладке появляется СОХРАНИТЬ.
- Изменения стараемся сохранять максимально "авто" (draft), но если есть несохранённые — показываем предупреждение при уходе/закрытии.

---

## 2) КАЛЬКУЛЯТОР: структура экрана

### 2.1 Шапка тендера / заказчика (Tender Header)
**Источник:** парсер (kontur/bidzaar) или ручной ввод.

**Редактируемость:**
- ВСЁ редактируемое, кроме: `source`, `sourceTenderId`, `lawType`, `links`.
- Если парсер не сработал — все обязательные поля вводятся вручную.

**Поля шапки (минимум):**
- этап, срок окончания подачи, площадка, ссылка
- закон (44-ФЗ/223-ФЗ), тип закупки
- заказчик (название, ИНН, КПП)
- контакт (ФИО, телефон, email)
- НМЦ
- обеспечение заявки (`securityBid`)
- обеспечение контракта (`securityContract`)
- тариф площадки (`platformFee`)
- средняя цена часа с площадки (`hourlyRateCustomer`)
- общее кол-во чч (`totalHours`)
- срок оказания услуг (`serviceStart`/`serviceEnd` + `months`)
- адреса объектов (массив)

### 2.2 Комментарии
Под шапкой:
- список комментариев по хронологии (снизу — самый свежий).
- поле ввода нового комментария + кнопка "Добавить".

### 2.3 Расчёт охраны (Guard Lines)
- Добавляем строки охраны из прайса (прайс — отдельная вкладка).
- В калькуляторе строки редактируются "локально" (обратно в прайс НЕ пишем).
- Нужен "индикатор остатка" (как при добавлении строк уменьшается/раскидывается: `totalHours` и/или бюджет).

#### Поля строки охраны (в калькуляторе)
**Обязательные:**
- краткое описание (текст) — тянем из прайса, редактируем
- режим работы, часы (число) — тянем из прайса, редактируем
- чч/мес (число) — тянем из прайса, редактируем
- ставка заказчика в час (число) — тянем из прайса, редактируем
- ставка сотрудника в смену (число) — тянем из прайса (поле "Ставка"), редактируем
- месяцев (число) — по умолчанию берём из срока тендера (или 12, если нет), редактируем
- кол-во постов (число) — редактируем
- итого в мес (число, авто)
- итого (число, авто)

**Дополнительно (полезно, но можно MVP):**
- адрес объекта (текст)
- форма одежды (enum/текст)
- описание строки (текст, хранится в CRM в составе расчёта)

**Критичное правило ставок:**
- ставка заказчика = "в час"
- ставка сотрудника (наша) = "в смену"
- сравнение/пересчёт делаем через усреднённый месяц 30.5

### 2.4 Дополнительные расходы (Expense Lines)
- Строки подтягиваются из прайса "Доп. расходы" (прайс — отдельная вкладка).
- В калькуляторе строки редактируются "локально".
- **Авто-строки по БГ:**
  - если есть обеспечение заявки — добавляем строку "БГ обеспечение заявки"
  - если есть обеспечение контракта — добавляем строку "БГ обеспечение контракта"
  - стоимость БГ считается по формулам из Excel (см. раздел 6.4)

#### Поля строки допрасхода (в калькуляторе)
- название (текст) — из прайса или авто (БГ)
- единица измерения (шт/день/мес)
- тип НДС/тип оплаты (ндс / без ндс / нал)
- цена (число)
- кол-во (число)
- периодичность (разово/ежемесячно) ← важно для "кол-во мес"
- итого (авто)

### 2.5 ИТОГО и 5 схем
**ИТОГО** = (охрана + допрасходы).

Если **ИТОГО > НМЦ** — подсветка ИТОГО красным, иначе зелёным.

Ниже: **5 колонок схем** (в порядке):
1. БЕЛ УСН
2. СЕР УСН
3. БЕЛ НДС
4. СЕР НДС
5. ИП НДС

В каждой колонке показываем:
- Рентабельность (margin %)
- Прибыль безнал (profitCashless)
- Прибыль нал (profitCash)

**"v"** — кнопка раскрыть выкладки (breakdown) по строкам.

**Цвет рентабельности:**
- < 5% → красный
- < 10% → жёлтый
- >= 10% → зелёный

---

## 3) CRM (внутри расширения)

**Подвкладки:**
- СДЕЛКИ
- ЗАДАЧИ
- КОНТРАГЕНТЫ
- МЕНЕДЖЕРЫ
- (опционально) НАСТРОЙКИ CRM — если нужно отделить от общих настроек расширения

### 3.1 Сделки
Список сделок, каждая сделка хранит:
- шапку тендера (если тендер) или ручной лид
- историю `CalculationGroup` (КП) по сделке
- комментарии
- статус обработки (`new`/`in_work`/`won`/… + визуальные "не обработан/в работе/победа")

**UI (желательно):**
- таблица + фильтры + поиск
- дополнительно: Канбан по стадиям

### 3.2 Задачи
Задачи привязаны к:
- сделке
- менеджеру

Обследование объекта делаем задачей (тип задачи = `site_survey`), чтобы не плодить сущности,
НО если нужно хранить анкету (структурные ответы) — используем `SiteSurvey.data`.

### 3.3 Контрагенты
Единый список:
- наши компании
- заказчики
- (в будущем: партнёры/конкуренты)

Храним:
- полные реквизиты
- тип контрагента (`our_company` / `customer` / `partner` / `competitor`)
- контакты

Фильтры по типу.

### 3.4 Менеджеры
- ФИО, должность, телефон, email
- роль (уровень доступа)
- возможность провалиться в сделки менеджера

---

## 4) ПРАЙС

Две таблицы, обе редактируемые построчно:
- **Охрана** (`GuardPrice`)
- **Допрасходы** (`ExpensePrice`)

**Кнопки:**
- удалить строку
- добавить строку
- СОХРАНИТЬ появляется при изменениях

### 4.1 Прайс "Охрана" — поля
- краткое описание (text)
- регион (text)
- оружие (bool)
- вахта (enum: нет / на объекте / хостел)
- режим, часы (number)
- чч в мес (number)
- в час (number) ← ставка заказчика
- в месяц (number) ← контроль/справочно
- ставка (number) ← наша ставка в смену
- описание (text)

### 4.2 Прайс "Допрасходы" — поля
- название (text)
- цена (number)
- ед. изм (enum: шт / день / мес)
- тип (enum: ндс / без ндс / нал)
- **периодичность** (enum: разово / ежемесячно) ← добавляем в прайс как обязательное

---

## 5) НАСТРОЙКИ (общие)

### 5.1 Настройки калькулятора
- **vatMode**: "наружу" | "внутри суммы"
  - наружу: НДС добавляется сверху
  - внутри суммы: НДС выделяется из суммы (для корректного сравнения одинаковых "включая НДС")
- **calcspecVersion/configVersion**: текущая версия коэффициентов
- значения по умолчанию (например МРОТ/фикс. белая часть для серых схем, если применимо)

### 5.2 Интеграции (позже/опционально)
- Telegram (token, chatId/@)
- Mango (API key)

---

## 6) ДАННЫЕ (каноническая модель + расширения)

### 6.1 Сущности (core)
Сохраняем базовые сущности:
- `Tender`
- `Deal`
- `CalculationGroup` (= КП/вариант расчёта)
- `Calculation` (результат по схеме)
- `Company`, `Contact`
- `User` (Manager)
- `Task`
- `SiteSurvey` (если нужна анкета)

**Ключевое требование:**
- `Deal` → много `CalculationGroup` (история КП), без перезаписи.

### 6.2 Маппинг статусов
`Deal.stage` (технические):
- `new`
- `in_work`
- `sent`
- `won`
- `lost`

Визуальные:
- `new` = не обработан
- `in_work` = в работе
- `won` = победа

### 6.3 Строки расчёта (добавляем в CalculationGroup)
В `CalculationGroup` храним "сырые" строки, по которым считали:
- `guardLines`: `GuardCalcLine[]`
- `expenseLines`: `ExpenseCalcLine[]`
- `commentThread`: `Comment[]` (или ссылки на общие комменты Tender/Deal)

**GuardCalcLine:**
- `priceItemId?` (ссылка на GuardPriceItem)
- `title` (краткое описание)
- `description?` (ручное)
- `hoursPerDay` (режим, часы)
- `hoursPerMonth` (чч/мес)
- `months`
- `posts`
- `customerHourlyRate`
- `ourShiftRate`
- `address?`
- `uniformType?`
- `totalPerMonth` (auto)
- `total` (auto)

**ExpenseCalcLine:**
- `priceItemId?` (ссылка на ExpensePriceItem)
- `title`
- `unit` (шт/день/мес)
- `vatType` (ндс/без ндс/нал)
- `periodicity` (once/monthly)
- `price`
- `qty`
- `total` (auto)

### 6.4 Формулы БГ (Excel → код)
**Обеспечение заявки:**
```
cost = MAX(1000; ROUND(securityBid * 0.0055; 0))
```

**Обеспечение контракта:**
```
cost = ROUND(securityContract * 0.0003; 0)
```

---

## 7) КАЛЬКУЛЯТОР: API и расчётные схемы

### 7.1 calc(input) → output
**CalcInput:**
- `baseAmount` = ИТОГО (охрана + допрасходы)
- `workload` = `{ posts, shifts, hoursPerPost }`
- `schemaSet` = `['BEL_USN','SER_USN','BEL_NDS','SER_NDS','IP_NDS']`
- `configVersion?` (версия calcspec.yaml)

**CalcOutput:**
- `calculations[]`: по одной на схему
  - `schemaCode`
  - `aggregates` (margin, profitCash, profitCashless, vat, avgRate, fot, taxes, envelope, otherExpenses, total)
  - `breakdown[]` (строки выкладок как в Excel)

### 7.2 Схемы (schemaCode)
**Коды (для данных):**
- `BEL_USN`
- `SER_USN`
- `BEL_NDS`
- `SER_NDS`
- `IP_NDS`

**Названия в UI:**
- "БЕЛ УСН", "СЕР УСН", "БЕЛ НДС", "СЕР НДС", "ИП НДС"

---

## 8) calcspec.yaml (где живут коэффициенты и логика)

Требование: все ставки/коэффициенты/настройки схем вынести в `calcspec.yaml`,
а код JS должен быть "движком", который интерпретирует spec.

**Минимальная структура (пример):**

```yaml
version: "2026-01-07"

constants:
  daysInMonth: 30.5
  vacation:
    avgDaysInMonth: 29.3
    vacationDaysPerYear: 28
    monthsInYear: 12

rates:
  ndfl: 0.13
  pfr: 0.30
  fss: 0.002
  profitTax: 0.25

vat:
  vat7:
    rate: 0.07
    insideDivider: 1.07
  vat22:
    rate: 0.22
    insideDivider: 1.22

cashout:
  standard:
    net: 0.85
    fee: 0.15

schemes:
  BEL_USN:
    vatMode: 7
    usnRate: 0.06
    usesGrossUp: true
  SER_USN:
    vatMode: 7
    usnRate: 0.06
    usesGrossUp: false
    officialSalaryFixed: 45000
    dividendTaxModel:
      net: 0.85
      fee: 0.15
  BEL_NDS:
    vatMode: 22
    usesGrossUp: true
  SER_NDS:
    vatMode: 22
    usesGrossUp: false
  IP_NDS:
    vatMode: 22
    usesGrossUp: false
```

---

## 9) MVP-хранение

Для MVP допускается `localStorage` (в расширении) как хранилище сделок/контрагентов/прайса/коэфов,
но структура должна совпадать с моделью, чтобы потом переехать на общий backend.

---

## 10) ASCII UI mockups (референс)

См. отдельный документ с ASCII-графикой интерфейсов или визуализацию выше.

**Основные экраны:**
1. КАЛЬКУЛЯТОР (шапка тендера + строки охраны + допрасходы + 5 схем)
2. CRM (сделки/задачи/контрагенты/менеджеры)
3. ПРАЙС (охрана + допрасходы, редактируемые таблицы)
4. НАСТРОЙКИ (calcspec версия, vatMode, интеграции)

---

## 11) Логика расчёта (calc_logic reference)

Полная спецификация логики калькулятора находится в отдельном документе `calc_logic.md`.

**Ключевые моменты:**

### Метод ГРОСС-АП (обратный расчёт ЗП)
Используется в "Белых" схемах для расчёта суммы в договоре, чтобы сотрудник получил желаемое "на руки".
```
Contract_Sum = (Net_Salary + Vacation_Reserve) / 0.87 * (100 / 87)
```

### Расчёт Резерва Отпуска
```
Reserve = (Salary_Total / 29.3) * (28 / 12)
```

### Выделение НДС из цены
**НДС 7%:**
```
VAT = Price / 107 * 7
```

**НДС 22%:**
```
VAT = Price / 122 * 22
```

### Комиссия за Обнал / Конверт
Используется в "Серых" схемах.
```
Fee = Amount / 0.85 * 0.15
```

### Налог на Прибыль (2025)
**Ставка:** 25% (новая ставка с 2025 года).
```
Profit_Tax = (Revenue_NoVAT - Expenses) * 0.25
```

---

## 12) Основные данные (справочники)

### Позиции прайса охраны

| Краткое описание | Регион | Оружие | Вахта | Режим, часы | ч.ч в мес | В час | В месяц | Ставка | Описание |
|---|---|---|---|---|---|---|---|---|---|
| МСК, 12/7 | Москва | — | — | 12 | 365 | 760,00 | 277 400,00 | 5 500 | Ежедневно, полусуточно, один сотрудник охраны со сменным режимом работы (г. Москва) |
| МСК, 12/7, вахта (на объекте) | Москва | — | На объекте | 12 | 365 | 602,74 | 220 000,10 | 4 000 | Ежедневно, полусуточно, один сотрудник охраны с вахтовым режимом работы (г. Москва) |
| МСК, 12/7, вахта (хостел) | Москва | — | Хостел | 12 | 365 | 685,00 | 250 025,00 | 4 700 | Ежедневно, полусуточно, один сотрудник охраны с вахтовым режимом работы (хостел) (г. Москва) |
| МСК, 24/7 | Москва | — | — | 24 | 730 | 534,25 | 390 002,50 | 7 500 | Ежедневно, круглосуточно, один сотрудник охраны со сменным режимом работы (г. Москва) |
| СПб, 12/7 | СПб | — | — | 12 | 365 | 602,74 | 220 000,10 | 4 000 | Ежедневно, полусуточно, один сотрудник охраны со сменным режимом работы (г. Санкт-Петербург) |
| СПб, 24/7 | СПб | — | — | 24 | 730 | 383,56 | 279 998,80 | 5 000 | Ежедневно, круглосуточно, один сотрудник охраны со сменным режимом работы (г. Санкт-Петербург) |
| СПб, 24/7, с оружием | СПб | Да | — | 24 | 730 | 534,25 | 390 002,50 | 7 500 | Ежедневно, круглосуточно, один сотрудник охраны со сменным режимом работы с оружем (г. Санкт-Петербург) |

### Дополнительные расходы

| название | цена | ед изм | тип | периодичность |
|---|---|---|---|---|
| хостел | 700,00 | день | б/ндс | ежемесячно |
| питание | 500,00 | день | б/ндс | ежемесячно |
| связь | 500,00 | мес | ндс | ежемесячно |
| антиБПЛА | 200 000,00 | шт | б/ндс | разово |
| обучение птм | 2 000,00 | шт | б/ндс | разово |
| обучение от | 2 000,00 | шт | б/ндс | разово |
| газоанализатор | 600 000,00 | шт | ндс | разово |
| телефон | 20 000,00 | шт | ндс | разово |
| ноутбук | 50 000,00 | шт | ндс | разово |
| интроскоп | 750 000,00 | шт | ндс | разово |
| машина | 1 000 000,00 | шт | ндс | разово |

### Менеджеры

| ФИО | Должность | Тел | email |
|---|---|---|---|
| Ломакин Владислав Алксандрович | Руководитель тендерного отдела | +7 (925) 707-09-11 | tender@sigma-profi.com |
| Данилюк Елена Михайловна | Коммерческий директор | +7 (916) 282-81-52 | help@sigma-profi.com |
| Меньщикова Оксана Петровна | Менеджер отдела продаж | +7 (903) 247-96-76 | info@sigma-profi.com |
| Серова Виктория Игоревна | Администратор отдела личной охраны | +7 (906) 033-37-89 | admin@sigma-profi.com |

### Наши компании

| Краткое название | ИНН | КПП | НДС |
|---|---|---|---|
| ЧОП «СИГМА-ПРОФИ» | 7707293185 | 771501001 | 7% |
| ЧОО «Сигма-Профи 2» | 7715940799 | 771501001 | 20% (22%) |
| ЧОП «Сигма-Профи 1» | 7716623545 | 771501001 | 7% |
| ЧОО «Сигма-Профи 3» | 6950195609 | 771501001 | 7% |
| ЧОП «СИГМА-ПРОФИ КОНСАЛТИНГ» | 7716663410 | 771601001 | 7% |

### Схемы расчётов

| Схема | Компании | Налоговый режим |
|---|---|---|
| БЕЛ УСН | СП, СП1, СПк | УСН 6% + НДС 7% |
| СЕР УСН | СП, СП1, СПк | УСН 6% + НДС 7% (серая ЗП) |
| БЕЛ НДС | СП2 | ОСНО + НДС 22% |
| СЕР НДС | СП2 | ОСНО + НДС 22% (серая ЗП) |
| ИП НДС | СП2 | ИП + НДС 22% (обнал) |

---

## Заключение

Этот документ объединяет:
- User Flow (парсинг → расчёт → CRM)
- UI спецификацию (4 вкладки + детали)
- Структуру данных (сущности + поля строк)
- Логику расчётов (5 схем + формулы)
- Справочники (прайс, допрасходы, менеджеры, компании)

Цель: любой разработчик/ИИ может взять этот файл и реализовать расширение/систему без доп. вопросов.
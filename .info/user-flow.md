# Kapusta — User Flow (Browser Extension)

## Цель
Расширение «Kapusta» помогает менеджеру быстро подготовить расчёт (КП) по закупке: получить исходные данные (из парсинга или вручную), выполнить расчёт по прайсу (охрана + доп.расходы) и сохранить результат в CRM так, чтобы в рамках одной сделки могла быть история из нескольких КП.

---

## 1) Открытие расширения
### 1.1 Определение контекста страницы
При открытии попапа расширение анализирует активную вкладку:
- Если вкладка находится на поддерживаемом сайте и страница содержит данные закупки — включается режим парсинга.
- Если вкладка не на поддерживаемом сайте — включается ручной режим (без попыток парсинга).

### 1.2 Поддерживаемые источники (на текущий момент)
- `bidzaar.com`
- `kontur.zakupki.ru`

> Примечание: список источников планируется расширять; при добавлении нового домена он должен быть внесён в список поддерживаемых правил/парсеров.

---

## 2) Получение общей информации по закупке
Перед расчётом должна быть заполнена «шапка» закупки (общая информация):
- Заказчик
- Объект/площадка
- Количество постов
- Срок (даты или период)

### 2.1 Автозаполнение (парсинг)
Если активен режим парсинга:
1) Расширение извлекает данные закупки со страницы.
2) Определяется уникальный ключ закупки (см. ниже).
3) Если по закупке уже есть сохранённая информация — повторный парсинг не выполняется; используются сохранённые данные.
4) Если информации нет — сохраняется распарсенная «шапка» и пользователь переходит к калькулятору.

### 2.2 Ручной ввод
Если активен ручной режим:
1) Расширение показывает форму ручного ввода «шапки».
2) Пользователь заполняет обязательные поля.
3) После валидации данных пользователь переходит к калькулятору.

---

## 3) Идентификация закупки (ключ)
Для исключения повторного парсинга и корректной привязки КП к сделке нужна стабильная идентификация закупки.

Рекомендуемое правило:
- Основной ключ: **внутренний ID** закупки (если он доступен на источнике).
- Фоллбек: номер закупки.

> Практика: номер закупки удобен, но не всегда гарантирует уникальность/стабильность, поэтому предпочтительнее внутренний ID (или составной ключ: `source + internalId`, а при отсутствии — `source + number`).

---

## 4) Расчёт (калькулятор)
После того как «шапка» закупки заполнена, пользователь переходит к расчёту.

Калькулятор состоит из двух разделов:
1) **Расчёт охраны**
2) **Дополнительные расходы**

### 4.1 Подтягивание данных из прайса
Данные для расчёта подтягиваются из прайса, в котором также два раздела:
- Охрана
- Дополнительные расходы

Принцип работы:
- Пользователь выбирает/настраивает строки расчёта, опираясь на позиции прайса.
- Итоговые суммы считаются на основании выбранных параметров.

---

## 5) Сохранение в CRM
После завершения расчёта пользователь сохраняет данные в CRM.

### 5.1 Создание/поиск сделки
Логика сохранения:
- Если сделки по данной закупке нет — создаётся новая сделка/закупка.
- Если сделка уже существует — новый расчёт сохраняется как **новое КП** внутри этой сделки.

### 5.2 История КП по сделке
В рамках одной сделки может быть несколько КП. Требования:
- Все КП должны сохраняться и быть доступны для просмотра (история расчётов).
- Должна быть кнопка **«Скопировать расчёт»** (создать новое КП на основе выбранного существующего), чтобы не заполнять всё заново.

---

## 6) Данные, которые хранит CRM (контекст)
CRM хранит и связывает между собой (минимальный перечень для данного флоу):
- Закупка/сделка
- Все КП (расчёты) по сделке
- Менеджеры
- Заказчики
- Контактные лица
- Объекты
- Обследования объектов
- Задачи и другие сущности

> В рамках расширения критично обеспечить правильную связь: «Сделка → множество КП», без перезаписи предыдущих расчётов.
